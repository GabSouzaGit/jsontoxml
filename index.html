<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Respostas em XML | Gabriel Souza </title>
</head>
<body>
    <div id="container">
        <header>
            <h1> 
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3">
                    <path d="M480-560 320-400l56 56 64-64v168h80v-168l64 64 56-56-160-160Zm-280-80v440h560v-440H200Zm0 520q-33 0-56.5-23.5T120-200v-499q0-14 4.5-27t13.5-24l50-61q11-14 27.5-21.5T250-840h460q18 0 34.5 7.5T772-811l50 61q9 11 13.5 24t4.5 27v499q0 33-23.5 56.5T760-120H200Zm16-600h528l-34-40H250l-34 40Zm264 300Z"/>
                </svg>
                <div>
                    Respostas em XML 
                </div>
            </h1>
        </header>
        <div id="url-insertion">
            <div id="input-area">
                <input type="url" placeholder="http://www.exemplo-de-api.com/ws/endpoint" id="endpoint">
                <div id="send" class="not-ready">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                        <path d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z"/>
                    </svg>
                </div>
            </div>
            <div id="fallback-url" class="hide"></div>
            <div class="legend">
                Insira a URL da sua API e recupere os dados em XML.
            </div>
        </div>
        <div id="receiver">
            <div id="drag-file">
                <div>
                    Arraste seu arquivo aqui<br>(em desenvolvimento).
                </div>
            </div>
            <div class="legend">
                Ou arraste um arquivo .json para a área tracejada.
            </div>
        </div>
    </div>
</body>
<script type="module">
    import jsonToXML from "./jsonToXML.js";

    async function request(url){
        const HTTP_STATS = {
            400: "Avalie se a URL foi passada corretamente ou se não há nenhuma informação incorreta.",
            401: "Verifique se a API precisa de algum token ou acesso para a requisição.",
            403: "Proibido. Verifique as opções de acesso do seu serviço.",
            404: "Recurso não encontrado. Verifique se a URL está correta e tente outra vez",
            405: "Verifique o método de requisição do seu endpoint. Este foi feito por GET.",
            500: "A API não pode responder. Tente novamente mais tarde.",
            503: "Esta API está temporariamente indisponível. Tente novamente mais tarde ou pesquise por mais informações sobre o serviço."
        }
    
        try {
            const GET_REQ = await fetch(url);
            const json = await GET_REQ.json();

            return json
        }catch(e){
            alert(e)
        }
    }

    const sender = document.querySelector("#send");
    const endpointInput = document.querySelector("#endpoint");
    const urlFallback = document.querySelector("#fallback-url");
    
    endpointInput.addEventListener('input', () => {
        if(endpointInput.value == ""){
            if(sender.classList.contains("not-ready")) return;
            sender.classList.add("not-ready");
            return
        };

        sender.classList.remove("not-ready");
    })

    sender.addEventListener('click', async () => {
        if(sender.classList.contains("not-ready")) return

        urlFallback.classList.remove("hide");
        const json = await request(endpointInput.value);
        const xml = jsonToXML({HTTPResponse: json});
        urlFallback.classList.add("hide");

        const xmlBlob = new Blob([xml], {type: "application/xml"});
        const urlToXML = URL.createObjectURL(xmlBlob);

        const anchor = document.createElement('a');
        anchor.href = urlToXML;
        anchor.download = "response.xml";
        anchor.click();
    })
</script>
</html>